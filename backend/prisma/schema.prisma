// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// Defina seu provedor de banco de dados aqui (ex: postgresql, mysql, sqlite, mongodb)
// Para um projeto robusto, PostgreSQL ou MySQL são boas escolhas.


// ----------------------------------------------------------------------
// 1. ADMIN (Para o Administrador - LEMA)
// ----------------------------------------------------------------------

model Admin {
  id       Int     @id @default(autoincrement())
  nome     String
  email    String  @unique
  senha    String // Armazenar hash da senha
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  twoFactorSecret   String?
}

// ----------------------------------------------------------------------
// 2. TURMAS (Para organizar os cursos e o QR Code)
// ----------------------------------------------------------------------

model Turma {
  id             Int          @id @default(autoincrement())
  nomeCurso      String
  // O QR Code é único por turma e dia, mas vamos gerar e armazenar
  // o 'token' único que é lido pelo QR Code.
  tokenAcesso    String       @unique // Token principal da Turma/Curso
  dataInicio     DateTime
  dataFim        DateTime?
  createdAt      DateTime     @default(now())

  // Relacionamentos
  participantes  Participante[]
  checkins       CheckIn[]
  qrCodes        QRCodeDia[] // Geração de QR Codes diários
  facilitadores  Facilitador[]
}

// Tabela para gerenciar os QR Codes únicos por dia.
// O participante precisa do QR_CODE + seu NOME para o Check-in.
model QRCodeDia {
  id             Int      @id @default(autoincrement())
  turmaId        Int
  dataReferencia DateTime @unique // Chave única por Turma e Dia (para garantir a unicidade)
  tokenQR        String   @unique // O valor real do QR Code gerado (ex: hash da turma + data)
  ativo          Boolean  @default(true)
  createdAt      DateTime @default(now())

  // Relacionamento
  turma Turma @relation(fields: [turmaId], references: [id])

  @@unique([turmaId, dataReferencia]) // A data de referência é única por turma
}

// ----------------------------------------------------------------------
// 3. PARTICIPANTES (Upload de Planilhas)
// ----------------------------------------------------------------------

// Enum para as opções de Cargo
enum Cargo {
  OPCAO_1
  OPCAO_2
  OPCAO_3
  OPCAO_4
}

model Participante {
  id             Int          @id @default(autoincrement())
  turmaId        Int          // Liga o participante a uma turma
  nomeCompleto   String
  whatsapp       String?
  email          String?
  municipio      String?
  cargo          Cargo?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relacionamentos
  turma            Turma        @relation(fields: [turmaId], references: [id])
  checkins         CheckIn[]
  historicoAlteracoes HistoricoAlteracao[] // Histórico de alterações feitas pelo participante
}

// ----------------------------------------------------------------------
// 4. CHECKINS (Registro de Presença)
// ----------------------------------------------------------------------

model CheckIn {
  id               Int          @id @default(autoincrement())
  participanteId   Int?         // Será nulo se for um Facilitador (ver campo 'facilitadorId')
  facilitadorId    Int?         // Será nulo se for um Participante (ver campo 'participanteId')
  turmaId          Int
  dataCheckIn      DateTime     @default(now())
  dataReferencia   DateTime     // A data do curso para a qual o check-in foi feito (Ex: 2025-10-26 00:00:00)

  // Logs de Acesso
  ipAcesso         String?
  geolocalizacao   String? // Pode ser um JSON ou String de coordenadas
  
  // Relacionamentos
  turma            Turma        @relation(fields: [turmaId], references: [id])
  participante     Participante? @relation(fields: [participanteId], references: [id])
  facilitador      Facilitador? @relation(fields: [facilitadorId], references: [id])

  // Restrição importante: Check-in único por participante/facilitador por dia (dataReferencia)
  // Nota: O Facilitador tem sua própria tabela
  @@unique([participanteId, dataReferencia])
  @@unique([facilitadorId, dataReferencia])
}

// ----------------------------------------------------------------------
// 5. FACILITADORES (Para o check-in do Facilitador)
// ----------------------------------------------------------------------

model Facilitador {
  id           Int      @id @default(autoincrement())
  turmaId      Int      // Liga o facilitador a uma turma
  nomeCompleto String
  email        String?
  whatsapp     String?
  createdAt    DateTime @default(now())

  // Relacionamentos
  turma       Turma      @relation(fields: [turmaId], references: [id])
  checkins    CheckIn[]
}

// ----------------------------------------------------------------------
// 6. LOGS (Logs de Acesso e Histórico de Alterações)
// ----------------------------------------------------------------------

// Logs gerais de acesso (para o Admin)
model LogAcesso {
  id             Int      @id @default(autoincrement())
  entidade       String   // Participante, Facilitador, Admin
  entidadeId     Int      // ID da entidade que fez o acesso
  acao           String   // Ex: 'PaginaCursoAcessada', 'BuscaNome', 'CheckIn', 'AjusteDados'
  ipAcesso       String?
  geolocalizacao String?
  dataHora       DateTime @default(now())
}

// Histórico de alterações cadastrais feitas pelos participantes (Para o Admin)
model HistoricoAlteracao {
  id             Int      @id @default(autoincrement())
  participanteId Int
  campoAlterado  String   // Ex: 'nomeCompleto', 'email', 'municipio'
  valorAntigo    String?
  valorNovo      String?
  dataAlteracao  DateTime @default(now())

  // Relacionamento
  participante Participante @relation(fields: [participanteId], references: [id])
}